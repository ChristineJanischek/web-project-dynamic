name: ðŸ”„ Template Sync to Dependent Repos

on:
  push:
    branches:
      - main
    paths:
      - 'docs/**'
      - 'version*/**'
      - 'templates/**'
      - 'scripts/**'
      - 'shared-examples/**'
      - '.github/workflows/**'
      - '.vscode/**'
      - 'README.md'
      - 'QUICKSTART_LIVE_SERVER.md'
      - 'ARCHITECTURE.md'
      - 'CONTRIBUTING.md'
  workflow_dispatch:
    inputs:
      force_sync:
        description: 'Force sync to all repos (ignore skip list)'
        required: false
        type: boolean
        default: false
      target_repos:
        description: 'Specific repos to sync (comma-separated, leave empty for all)'
        required: false
        type: string

env:
  # Liste der abhÃ¤ngigen Repositories (Format: owner/repo)
  # Passe diese Liste an deine GitHub Classroom Repos an
  DEPENDENT_REPOS: |
    ChristineJanischek/web-project-student-example
  
jobs:
  detect-changes:
    name: ðŸ“Š Detect Template Changes
    runs-on: ubuntu-latest
    outputs:
      has_changes: ${{ steps.check.outputs.has_changes }}
      changed_files: ${{ steps.check.outputs.changed_files }}
    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 2
      
      - name: Detect Changed Files
        id: check
        run: |
          # Hole geÃ¤nderte Dateien seit letztem Commit
          CHANGED=$(git diff --name-only HEAD^ HEAD | grep -E '^(docs|version|templates|scripts|shared-examples|\.github)' || true)
          
          if [ -n "$CHANGED" ]; then
            echo "has_changes=true" >> $GITHUB_OUTPUT
            echo "changed_files<<EOF" >> $GITHUB_OUTPUT
            echo "$CHANGED" >> $GITHUB_OUTPUT
            echo "EOF" >> $GITHUB_OUTPUT
            
            echo "ðŸ“ Detected changes in:"
            echo "$CHANGED"
          else
            echo "has_changes=false" >> $GITHUB_OUTPUT
            echo "â„¹ï¸ No relevant template changes detected"
          fi
      
      - name: Create Change Summary
        run: |
          echo "## ðŸ“¢ Template Changes Detected" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "The following files have been updated:" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "\`\`\`" >> $GITHUB_STEP_SUMMARY
          git diff --name-only HEAD^ HEAD >> $GITHUB_STEP_SUMMARY
          echo "\`\`\`" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "ðŸ”„ Automatic sync will create Pull Requests in dependent repositories." >> $GITHUB_STEP_SUMMARY

  sync-to-repos:
    name: ðŸ”„ Sync to Dependent Repos
    runs-on: ubuntu-latest
    needs: detect-changes
    if: needs.detect-changes.outputs.has_changes == 'true' || github.event.inputs.force_sync == 'true'
    
    steps:
      - name: ðŸ“¥ Checkout Template Repository
        uses: actions/checkout@v4
        with:
          path: template
          fetch-depth: 0
      
      - name: ðŸ”§ Setup Git
        run: |
          git config --global user.name "Template Sync Bot"
          git config --global user.email "noreply@github.com"
      
      - name: ðŸ”„ Sync to Dependent Repositories
        env:
          GH_TOKEN: ${{ secrets.TEMPLATE_SYNC_TOKEN }}
        run: |
          # Falls ein Personal Access Token benÃ¶tigt wird:
          # 1. Gehe zu GitHub Settings > Developer settings > Personal access tokens
          # 2. Erstelle einen Token mit "repo" und "workflow" Rechten
          # 3. FÃ¼ge ihn als Secret "TEMPLATE_SYNC_TOKEN" hinzu
          
          if [ -z "$GH_TOKEN" ]; then
            echo "âš ï¸ TEMPLATE_SYNC_TOKEN not configured"
            echo "â„¹ï¸ Automatic sync requires a Personal Access Token"
            echo "ðŸ“š See: https://docs.github.com/en/authentication/keeping-your-account-and-data-secure/creating-a-personal-access-token"
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "## âš ï¸ Configuration Required" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "To enable automatic syncing:" >> $GITHUB_STEP_SUMMARY
            echo "1. Create a Personal Access Token with \`repo\` and \`workflow\` permissions" >> $GITHUB_STEP_SUMMARY
            echo "2. Add it as a repository secret named \`TEMPLATE_SYNC_TOKEN\`" >> $GITHUB_STEP_SUMMARY
            echo "3. Update \`DEPENDENT_REPOS\` in this workflow with your classroom repositories" >> $GITHUB_STEP_SUMMARY
            exit 0
          fi
          
          echo "ðŸ”„ Starting template sync process..."
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "## ðŸ”„ Sync Results" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          # Liste der zu synchronisierenden Repositories
          REPOS=$(echo "$DEPENDENT_REPOS" | grep -v '^#' | grep -v '^$' || true)
          
          if [ -z "$REPOS" ]; then
            echo "â„¹ï¸ No dependent repositories configured"
            echo "Configure them in DEPENDENT_REPOS environment variable" >> $GITHUB_STEP_SUMMARY
            exit 0
          fi
          
          # Synchronisiere jedes Repository
          while IFS= read -r repo; do
            [ -z "$repo" ] && continue
            
            echo "ðŸ“¦ Processing: $repo"
            
            # Clone target repository
            git clone "https://x-access-token:${GH_TOKEN}@github.com/${repo}.git" "target-${repo##*/}" 2>/dev/null || {
              echo "âŒ Failed to clone $repo" >> $GITHUB_STEP_SUMMARY
              continue
            }
            
            cd "target-${repo##*/}"
            
            # Check if sync is disabled
            if [ -f ".template-sync-ignore" ]; then
              echo "â­ï¸ Skipping $repo (sync disabled)"
              echo "- â­ï¸ \`$repo\` - Sync disabled" >> $GITHUB_STEP_SUMMARY
              cd ..
              continue
            fi
            
            # Create sync branch
            BRANCH_NAME="template-sync-$(date +%Y%m%d-%H%M%S)"
            git checkout -b "$BRANCH_NAME"
            
            # Copy template files (exclude student work directories)
            rsync -av --delete \
              --exclude='.git' \
              --exclude='version*/aufgabe/index.html' \
              --exclude='version*/aufgabe/css/style.css' \
              --exclude='version*/aufgabe/js/script.js' \
              --exclude='version*/loesung' \
              --exclude='**/projects/*' \
              --exclude='**/surveys/*/results' \
              ../template/docs ./
            
            rsync -av \
              --exclude='.git' \
              ../template/scripts ./
            
            cp ../template/README.md ./ 2>/dev/null || true
            cp ../template/CONTRIBUTING.md ./ 2>/dev/null || true
            cp ../template/TEMPLATE_SYNC.md ./ 2>/dev/null || true
            
            # Check for changes
            if git diff --quiet && git diff --cached --quiet; then
              echo "â„¹ï¸ No changes for $repo"
              echo "- âœ… \`$repo\` - Already up to date" >> $GITHUB_STEP_SUMMARY
              cd ..
              continue
            fi
            
            # Commit and push
            git add .
            git commit -m "ðŸ”„ Template sync from web-project-dynamic" \
              -m "Automatic synchronization from template repository" \
              -m "" \
              -m "Template commit: ${{ github.sha }}" \
              -m "Sync date: $(date -u +'%Y-%m-%d %H:%M:%S UTC')" \
              -m "" \
              -m "Review changes before merging." \
              -m "To disable auto-sync, create: .template-sync-ignore"
            
            git push origin "$BRANCH_NAME"
            
            # Create Pull Request (PR body in single line to avoid YAML issues)
            gh pr create \
              --title "ðŸ”„ Template Update $(date +%Y-%m-%d)" \
              --body "Automatisches Template-Update - Ã„nderungen wurden synchronisiert. ÃœberprÃ¼fe die Ã„nderungen und merge wenn alles passt." \
              --label "template-sync" \
              --repo "$repo" 2>&1 | tee pr_output.txt
            
            if [ $? -eq 0 ]; then
              PR_URL=$(grep -oP 'https://github.com/[^\s]+' pr_output.txt | head -1)
              echo "- âœ… \`$repo\` - [PR created]($PR_URL)" >> $GITHUB_STEP_SUMMARY
            else
              echo "- âš ï¸ \`$repo\` - PR creation failed" >> $GITHUB_STEP_SUMMARY
            fi
            
            cd ..
          done <<< "$REPOS"
          
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "âœ… Sync process completed" >> $GITHUB_STEP_SUMMARY

  notify-manual-sync:
    name: ðŸ“¢ Info for Manual Sync
    runs-on: ubuntu-latest
    needs: detect-changes
    if: needs.detect-changes.outputs.has_changes == 'true'
    
    steps:
      - name: Manual Sync Instructions
        run: |
          echo "## ðŸ“– Manual Sync Instructions" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "Falls automatisches Sync nicht konfiguriert ist:" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "\`\`\`bash" >> $GITHUB_STEP_SUMMARY
          echo "# 1. Template als Remote hinzufÃ¼gen" >> $GITHUB_STEP_SUMMARY
          echo "git remote add template https://github.com/ChristineJanischek/web-project-dynamic.git" >> $GITHUB_STEP_SUMMARY
          echo "git fetch template" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "# 2. Nur Dokumentation Ã¼bernehmen" >> $GITHUB_STEP_SUMMARY
          echo "git checkout template/main -- docs/" >> $GITHUB_STEP_SUMMARY
          echo "git checkout template/main -- README.md" >> $GITHUB_STEP_SUMMARY
          echo "git commit -m 'ðŸ“š Update from template'" >> $GITHUB_STEP_SUMMARY
          echo "\`\`\`" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "3. **Neue Version Ã¼bernehmen (z.B. Version 4):**" >> $GITHUB_STEP_SUMMARY
          echo "\`\`\`bash" >> $GITHUB_STEP_SUMMARY
          echo "git checkout template/main -- version4/" >> $GITHUB_STEP_SUMMARY
          echo "git commit -m 'âœ¨ Version 4 vom Template hinzugefÃ¼gt'" >> $GITHUB_STEP_SUMMARY
          echo "\`\`\`" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "4. **Workflows aktualisieren:**" >> $GITHUB_STEP_SUMMARY
          echo "\`\`\`bash" >> $GITHUB_STEP_SUMMARY
          echo "git checkout template/main -- .github/workflows/" >> $GITHUB_STEP_SUMMARY
          echo "git commit -m 'ðŸ”§ Workflows vom Template aktualisiert'" >> $GITHUB_STEP_SUMMARY
          echo "\`\`\`" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "âš ï¸ **Wichtig:** Ãœberschreibe niemals deine eigenen LÃ¶sungen in \`version*/aufgabe/\`!" >> $GITHUB_STEP_SUMMARY

name: ğŸ”” Template-Update Benachrichtigung

on:
  push:
    branches:
      - main
    paths:
      - 'docs/**'
      - 'version*/**'
      - 'scripts/**'
      - 'templates/**'
      - 'ka_grundlagen/**'
      - 'README.md'
      - '.github/**'

jobs:
  notify-update:
    runs-on: ubuntu-latest
    permissions:
      contents: read
    
    steps:
      - name: ğŸ“¥ Repository auschecken
        uses: actions/checkout@v4
        with:
          fetch-depth: 2

      - name: ğŸ“Š Ã„nderungen ermitteln
        id: changes
        run: |
          # Ermittle die Unterschiede zum vorherigen Commit
          CHANGED_FILES=$(git diff --name-only HEAD~1..HEAD)
          echo "changed_files<<EOF" >> $GITHUB_OUTPUT
          echo "$CHANGED_FILES" >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT
          
          # Kategorisiere die Ã„nderungen
          if echo "$CHANGED_FILES" | grep -q "^docs/"; then
            echo "has_docs=true" >> $GITHUB_OUTPUT
          fi
          if echo "$CHANGED_FILES" | grep -q "^version"; then
            echo "has_versions=true" >> $GITHUB_OUTPUT
          fi
          if echo "$CHANGED_FILES" | grep -q "^ka_grundlagen/"; then
            echo "has_exam=true" >> $GITHUB_OUTPUT
          fi
          if echo "$CHANGED_FILES" | grep -q "^scripts/"; then
            echo "has_scripts=true" >> $GITHUB_OUTPUT
          fi

      - name: ğŸ” Commit-Message auslesen
        id: commit
        run: |
          COMMIT_MSG=$(git log -1 --pretty=%B)
          echo "message<<EOF" >> $GITHUB_OUTPUT
          echo "$COMMIT_MSG" >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT

      - name: ğŸ“ Update-Log erstellen
        run: |
          cat > /tmp/update_info.txt << 'EOF'
          ğŸ¯ TEMPLATE-UPDATE VERFÃœGBAR
          =============================
          
          Commit: ${{ github.sha }}
          Branch: ${{ github.ref_name }}
          Autor: ${{ github.actor }}
          
          ğŸ“ Commit-Nachricht:
          ${{ steps.commit.outputs.message }}
          
          ğŸ“‚ GeÃ¤nderte Kategorien:
          ${{ steps.changes.outputs.has_docs == 'true' && 'âœ… Dokumentation (docs/)' || '' }}
          ${{ steps.changes.outputs.has_versions == 'true' && 'âœ… Versionen & Aufgaben (version*/)' || '' }}
          ${{ steps.changes.outputs.has_exam == 'true' && 'âœ… Klassenarbeit & LÃ¶sungen (ka_grundlagen/)' || '' }}
          ${{ steps.changes.outputs.has_scripts == 'true' && 'âœ… Scripts & Tools (scripts/)' || '' }}
          
          ğŸ”§ NÃ¤chste Schritte fÃ¼r abhÃ¤ngige Repos:
          
          1. Einmalig (falls nicht gemacht):
             git remote add template https://github.com/${{ github.repository }}.git
          
          2. Updates abrufen:
             git fetch template
          
          3. Selektiv Ã¼bernehmen:
             git merge template/main --no-edit --allow-unrelated-histories
          
          ğŸ“– Weitere Infos: TEMPLATE_SYNC.md
          EOF
          cat /tmp/update_info.txt

      - name: ğŸ“¢ Release Notes (optional)
        if: contains(github.event.head_commit.message, 'release:')
        run: |
          echo "ğŸš€ Dies ist ein Release-Update!"
          echo "AbhÃ¤ngige Repos sollten prioritÃ¤r aktualisiert werden."

  verify-syntax:
    runs-on: ubuntu-latest
    needs: notify-update
    
    steps:
      - name: ğŸ“¥ Repository auschecken
        uses: actions/checkout@v4

      - name: âœ… Validiere HTML-Dateien
        run: |
          find . -name "*.html" -type f ! -path "./node_modules/*" -print0 | \
          xargs -0 -I {} sh -c 'echo "Checking: {}"; grep -q "<!DOCTYPE html>" {} || echo "âš ï¸ DOCTYPE missing in {}"' || true

      - name: âœ… Validiere Markdown-Syntax
        run: |
          find . -name "*.md" -type f ! -path "./node_modules/*" | head -5 | while read f; do
            echo "âœ“ Checking: $f"
            test -s "$f" && echo "  âœ“ Datei OK" || echo "  âœ— Datei leer"
          done

      - name: ğŸ PrÃ¼fe Python-Syntax
        run: |
          python3 -m py_compile scripts/*.py 2>&1 | head -20 || echo "âš ï¸ Python-Dateien vorhanden"

      - name: ğŸ“Š Generiere Update-Summary
        run: |
          cat > UPDATE_SUMMARY.txt << 'EOF'
          ğŸ“¦ Template-Update Summary
          ==========================
          
          Generiert: $(date)
          Repo: ${{ github.repository }}
          Branch: ${{ github.ref_name }}
          
          Diese Datei kann an abhÃ¤ngige Repos weitergegeben werden.
          EOF
          cat UPDATE_SUMMARY.txt
